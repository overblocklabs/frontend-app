"use client"

import base64url from "base64url";
import { Buffer } from "buffer";
import {
    account,
    fundPubkey,
    fundSigner,
    native,
    server,
} from "../src/app/lib/common";
import { Keypair } from "@stellar/stellar-sdk/minimal";
import { SignerStore, SignerKey, type SignerLimits, type Signer } from "passkey-kit";
import { useRef, useState } from "react";

export default function Client() {

    const ADMIN_KEY = "AAAAEAAAAAEAAAABAAAAAQ=="; // TODO very rough until we're actually parsing the limits object
    const NATIVE_SAC =
        "CDLZFC3SYJYDZT7K67VZ75HPJVIEUVNIXF47ZG2FB2RMQQVU2HHGCYSC";
    const SAMPLE_POLICY =
        "CBJQC7FVOAJTBMOOSRUTAED3JVHGNHPKSKPXSREOWFHL7O6LW2ATQZAU";
    const SECRET = "SBEIDWQVWNLPCP35EYQ6GLWKFQ2MDY7APRLOQ3AJNU6KSE7FXGA7C55W";
    const PUBLIC = "GBVQMKYWGELU6IKLK2U6EIIHTNW5LIUYJE7FUQPG4FAB3QQ3KAINFVYS";

    const [isConnected, setIsConnected] = useState<boolean>(false)

    const contractId = useRef<string>('')
    const keyId = useRef<string>('')
    const adminSigner = useRef<string|undefined>(undefined)
    const balance = useRef<string|undefined>(undefined)
    const signers = useRef<Signer[]>([])

    let keyName: string = "";

    const getWalletBalance = async () => {
        console.log(contractId.current)
        const { result } = await native.balance({ id: contractId.current });

        balance.current = result.toString();
        console.log(balance);
    }

    const getWalletSigners = async () => {
        signers.current = await server.getSigners(contractId.current);
        console.log(signers.current);

        const adminKeys = signers.current.filter(({ limits }) => limits === ADMIN_KEY);
        if (!adminKeys.length) {
            return
        }

        adminSigner.current = (
            adminKeys?.find(({ key }) => keyId.current === key) || adminKeys[0]
        ).key;
    }

    const fundWallet = async () => {
        const { built, ...transfer } = await native.transfer({
            to: contractId.current,
            from: fundPubkey,
            amount: BigInt(100 * 10_000_000),
        });

        await transfer.signAuthEntries({
            address: fundPubkey,
            signAuthEntry: fundSigner.signAuthEntry,
        });

        const res = await server.send(built!);

        console.log(res);

        await getWalletBalance();
    }

    const connect = async (keyId_?: string) => {
        try {
            // const { keyId: kid, contractId: cid } = await account.connectWallet(
            const x = await account.connectWallet(
                {
                    keyId: keyId_,
                    getContractId: (keyId) => server.getContractId({ keyId }),
                },
            );
            console.log(x)

            const { keyId: kid, contractId: cid } = x

            keyId.current = base64url(kid);
            localStorage.setItem("sp:keyId", keyId.current);

            contractId.current = cid
            console.log("connect", cid);

            setIsConnected(true)

            await getWalletBalance();
            await getWalletSigners();
        } catch (err) {
            console.error(err);
            // alert(err.message)
        }
    }

    const handleRegister = async () => {
        const user = prompt("Give this passkey a name");
        if (!user) return;

        try {
            const {
                keyId: kid,
                contractId: cid,
                signedTx,
            } = await account.createWallet("Super Peach", user);

            const res = await server.send(signedTx);

            console.log(res);

            keyId.current = base64url(kid);
            localStorage.setItem("sp:keyId", keyId.current);
            contractId.current = cid
            console.log("register", cid);

            setIsConnected(true)

            await getWalletSigners();
            await fundWallet();

        } catch (err) {
            console.error(err);
        }

    }

    const reset = () => {
        localStorage.removeItem("sp:keyId");
        location.reload();
    }

    return <div>
        <button onClick={handleRegister}>register</button>
        <button onClick={() => connect()}>Sign In</button>
        <button onClick={reset}>reset</button>
        {isConnected && <>
            <button onClick={fundWallet}>Add Funds</button>
            <button onClick={getWalletBalance}>Get Balance</button>
        </>}
    </div>
}